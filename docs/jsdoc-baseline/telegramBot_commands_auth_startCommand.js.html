<!doctype html>
<html>

<head>
  <meta name="generator" content="JSDoc 3.6.11">
  <meta charset="utf-8">
  <title>Source: telegramBot/commands/auth/startCommand.js</title>
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Karla:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Noto+Serif:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Inconsolata:500" type="text/css">
  <link href="css/baseline.css" rel="stylesheet">
</head>

<body onload="prettyPrint()">
  <nav id="jsdoc-navbar" role="navigation" class="jsdoc-navbar">
    <div id="jsdoc-navbar-container">
      <div id="jsdoc-navbar-content">
        <a href="index.html" class="jsdoc-navbar-package-name">Home</a>
      </div>
    </div>
  </nav>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: telegramBot/commands/auth/startCommand.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>/**
 * @module telegramBot/commands/auth/start
 * @description –ö–æ–º–∞–Ω–¥–∞ /start –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ Telegram –±–æ—Ç–µ.
 */
import { Markup } from &#x27;telegraf&#x27;;
import prisma from &#x27;../../../utils/prismaConfig/prismaClient.js&#x27;;
import { logTelegramCommandError } from &#x27;../../../utils/loggers/telegramLoggers.js&#x27;;
import {
  getUserTempData,
  deleteUserTempData,
} from &#x27;../../../store/userTempData.js&#x27;;
import send from &#x27;../../send.js&#x27;;

export default function registerStartCommand(bot) {
  bot.start(async (ctx) &#x3D;&gt; {
    const authUrl &#x3D; &#x27;https://sharkflow.onrender.com/&#x27;;

    const messageText &#x3D; ctx.message?.text || &#x27;&#x27;;

    const args &#x3D; messageText.split(&#x27; &#x27;);
    const nonce &#x3D; args[1];

    const telegramId &#x3D; BigInt(ctx.from?.id);

    const existingUser &#x3D; await prisma.user.findFirst({
      where: { telegramId, isDeleted: false },
    });

    if (existingUser) {
      return await send(ctx, &#x27;–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.&#x27;);
    }

    if (!nonce || typeof nonce !&#x3D;&#x3D; &#x27;string&#x27; || nonce.length &gt; 100) {
      return await send(
        ctx,
        &#x60;–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Å—ã–ª–∫–∏: ${authUrl}&#x60;,
      );
    }

    try {
      const data &#x3D; await getUserTempData(&#x27;telegramAuth&#x27;, nonce);

      if (!data) {
        return await send(
          ctx,
          &#x60;–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞ –∏—Å—Ç—ë–∫ –∏–ª–∏ –æ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${authUrl}&#x60;,
        );
      }

      const userUuid &#x3D; data?.userUuid;

      if (typeof userUuid !&#x3D;&#x3D; &#x27;string&#x27;) {
        logTelegramCommandError(&#x27;start&#x27;, userUuid, new Error(&#x27;–û–∂–∏–¥–∞–ª–∞—Å—å —Å—Ç—Ä–æ–∫–∞ –¥–ª—è userUuid&#x27;));
        return await send(
          ctx,
          &#x27;–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ Telegram. –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.&#x27;,
        );
      }

      await deleteUserTempData(&#x27;telegramAuth&#x27;, nonce);

      const user &#x3D; await prisma.user.findFirst({
        where: { uuid: userUuid, isDeleted: false },
        select: { telegramId: true },
      });

      if (!user) {
        logTelegramCommandError(&#x27;start&#x27;, userUuid, new Error(&#x27;–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω&#x27;));
        await ctx.reply(&#x27;‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ&#x27;);
        return;
      }

      if (user.telegramId) {
        return await send(ctx, &#x27;–í—ã —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–ª–∏ Telegram –∫ —Å–≤–æ–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É.&#x27;);
      }

      const existingUserWithTelegramId &#x3D; await prisma.user.findFirst({
        where: {
          telegramId,
          isDeleted: false,
          uuid: { not: userUuid },
        },
      });

      if (existingUserWithTelegramId) {
        return await send(
          ctx,
          &#x27;–≠—Ç–æ—Ç Telegram —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É.&#x27;,
        );
      }

      await prisma.user.update({
        where: { uuid: userUuid },
        data: { telegramId, telegramEnabled: true },
      });

      const message &#x3D; &#x60;
        ‚úÖ &amp;lt;b&gt;Telegram —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É!&amp;lt;/b&gt;
        
        –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∞–º–∏ –∏ –∑–∞–¥–∞—á–∞–º–∏!.
      &#x60;.trim();

      const keyboard &#x3D; Markup.inlineKeyboard([
        Markup.button.callback(&#x27;üéØ –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é&#x27;, &#x27;back_to_main&#x27;),
      ]);

      return await send(ctx, message, keyboard);
    } catch (error) {
      logTelegramCommandError(&#x27;start&#x27;, userUuid, error);
      await ctx.reply(&#x27;‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ Telegram&#x27;);
    }
  });
}
</code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
  <footer id="jsdoc-footer" class="jsdoc-footer">
    <div id="jsdoc-footer-container">
      <p>
        Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> 3.6.11 on July 14, 2025.
      </p>
    </div>
  </footer>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/tree.jquery.js"></script>
  <script src="scripts/prettify.js"></script>
  <script src="scripts/jsdoc-toc.js"></script>
  <script src="scripts/linenumber.js"></script>
  <script src="scripts/scrollanchor.js"></script>
</body>

</html>