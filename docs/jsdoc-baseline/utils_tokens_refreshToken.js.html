<!doctype html>
<html>

<head>
  <meta name="generator" content="JSDoc 3.6.11">
  <meta charset="utf-8">
  <title>Source: utils/tokens/refreshToken.js</title>
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Karla:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Noto+Serif:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Inconsolata:500" type="text/css">
  <link href="css/baseline.css" rel="stylesheet">
</head>

<body onload="prettyPrint()">
  <nav id="jsdoc-navbar" role="navigation" class="jsdoc-navbar">
    <div id="jsdoc-navbar-container">
      <div id="jsdoc-navbar-content">
        <a href="index.html" class="jsdoc-navbar-package-name">Home</a>
      </div>
    </div>
  </nav>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: utils/tokens/refreshToken.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>/**
 * @module tokens/refresh
 * @description Функции для работы с refresh-токенами.
 */
import jwt from &#x27;jsonwebtoken&#x27;;
import { generateUUID } from &#x27;../generators/generateUUID.js&#x27;;
import { getRefreshCookieOptions } from &#x27;../cookie/loginCookie.js&#x27;;
import prisma from &#x27;../prismaConfig/prismaClient.js&#x27;;

/**
 * Создает JWT refresh-токен
 * @param {string} userUuid - UUID пользователя
 * @param {boolean} [rememberMe&#x3D;false] - Запомнить пользователя
 * @returns {string} JWT refresh-токен
 */
function createRefreshToken(userUuid, rememberMe &#x3D; false) {
  const expiresIn &#x3D; rememberMe
    ? process.env.JWT_REFRESH_EXPIRES_REMEMBER || &#x27;30d&#x27;
    : process.env.JWT_REFRESH_EXPIRES_NO_REMEMBER || &#x27;1d&#x27;;

  const payload &#x3D; {
    userUuid,
    jti: generateUUID(),
  };

  return jwt.sign(payload, process.env.JWT_REFRESH_SECRET, {
    expiresIn,
    algorithm: &#x27;HS256&#x27;,
  });
}

/**
 * Выдает refresh-токен и сохраняет его в базе данных
 * @param {Object} params - Параметры
 * @param {Object} [params.res] - Express response объект
 * @param {string} params.userUuid - UUID пользователя
 * @param {boolean} [params.rememberMe&#x3D;false] - Запомнить пользователя
 * @param {boolean} [params.setCookie&#x3D;true] - Установить куки
 * @param {number} [params.userId&#x3D;null] - ID пользователя (если известен)
 * @param {number} [params.deviceSessionId&#x3D;null] - ID сессии устройства
 * @returns {Promise&amp;lt;string&gt;} Refresh-токен
 * @throws {Error} Если пользователь не найден
 */
export async function issueRefreshToken({
  res,
  userUuid,
  rememberMe &#x3D; false,
  setCookie &#x3D; true,
  userId &#x3D; null,
  deviceSessionId &#x3D; null,
}) {
  const refreshToken &#x3D; createRefreshToken(userUuid, rememberMe);

  const expiresMs &#x3D; rememberMe
    ? Number(process.env.SESSION_EXPIRES_REMEMBER_ME)
    : Number(process.env.SESSION_EXPIRES_DEFAULT);
  const expiresAt &#x3D; new Date(Date.now() + expiresMs);

  let user;

  if (userId) {
    user &#x3D; { id: userId };
  } else {
    user &#x3D; await prisma.user.findFirst({
      where: { uuid: userUuid, isDeleted: false },
    });

    if (!user) {
      throw new Error(&#x27;Пользователь не найден&#x27;);
    }
  }

  await prisma.refreshToken.create({
    data: {
      userId: user.id,
      token: refreshToken,
      expiresAt,
      revoked: false,
      rememberMe,
      deviceSessionId,
    },
  });

  if (setCookie &amp;amp;&amp;amp; res &amp;amp;&amp;amp; !res.headersSent) {
    res.cookie(
      &#x27;log___tf_12f_t2&#x27;,
      refreshToken,
      getRefreshCookieOptions(rememberMe),
    );
  }

  return refreshToken;
}
</code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
  <footer id="jsdoc-footer" class="jsdoc-footer">
    <div id="jsdoc-footer-container">
      <p>
        Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> 3.6.11 on July 14, 2025.
      </p>
    </div>
  </footer>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/tree.jquery.js"></script>
  <script src="scripts/prettify.js"></script>
  <script src="scripts/jsdoc-toc.js"></script>
  <script src="scripts/linenumber.js"></script>
  <script src="scripts/scrollanchor.js"></script>
</body>

</html>