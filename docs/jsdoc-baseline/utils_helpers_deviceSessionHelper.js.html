<!doctype html>
<html>

<head>
  <meta name="generator" content="JSDoc 3.6.11">
  <meta charset="utf-8">
  <title>Source: utils/helpers/deviceSessionHelper.js</title>
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Karla:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Noto+Serif:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Inconsolata:500" type="text/css">
  <link href="css/baseline.css" rel="stylesheet">
</head>

<body onload="prettyPrint()">
  <nav id="jsdoc-navbar" role="navigation" class="jsdoc-navbar">
    <div id="jsdoc-navbar-container">
      <div id="jsdoc-navbar-content">
        <a href="index.html" class="jsdoc-navbar-package-name">Home</a>
      </div>
    </div>
  </nav>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: utils/helpers/deviceSessionHelper.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>/**
 * @module helpers/deviceSession
 * @description Вспомогательные функции для работы с сессиями устройств.
 */
import prisma from &#x27;../prismaConfig/prismaClient.js&#x27;;
import { parseDeviceInfo } from &#x27;./authHelpers.js&#x27;;
import axios from &#x27;axios&#x27;;
import { logLocationError } from &#x27;../loggers/systemLoggers.js&#x27;;

/**
 * Получение геолокации по IP адресу
 * @param {string} ipAddress - IP адрес
 * @returns {Promise&amp;lt;Object|null&gt;} Объект с геолокацией или null
 * @example
 * const geoLocation &#x3D; await getGeoLocation(&#x27;192.168.1.1&#x27;);
 */
export const getGeoLocation &#x3D; async (ipAddress) &#x3D;&gt; {
  try {
    const { data } &#x3D; await axios.get(&#x60;https://ipwho.is/${ipAddress}&#x60;);
    return data;
  } catch (error) {
    logLocationError(ipAddress, error);
    return null;
  }
};

/**
 * Создание или обновление сессии устройства пользователя
 * @param {Object} params - Параметры для создания/обновления сессии
 * @param {number} params.userId - ID пользователя
 * @param {string} params.deviceId - ID устройства
 * @param {string} params.userAgent - User-Agent строка
 * @param {string} params.ipAddress - IP адрес
 * @param {string|null} params.referrer - Referrer заголовок
 * @param {Object|null} params.geoLocation - Геолокация
 * @returns {Promise&amp;lt;Object&gt;} Объект сессии устройства
 * @example
 * const deviceSession &#x3D; await createOrUpdateDeviceSession({
 *   userId: 1,
 *   deviceId: &#x27;device123&#x27;,
 *   userAgent: &#x27;Mozilla/5.0...&#x27;,
 *   ipAddress: &#x27;192.168.1.1&#x27;,
 *   referrer: &#x27;https://example.com&#x27;,
 *   geoLocation: { country: &#x27;Russia&#x27; }
 * });
 */
export const createOrUpdateDeviceSession &#x3D; async ({
  userId,
  deviceId,
  userAgent,
  ipAddress,
  referrer &#x3D; null,
  geoLocation &#x3D; null,
}) &#x3D;&gt; {
  const deviceinfo &#x3D; parseDeviceInfo(userAgent);

  let deviceSession &#x3D; await prisma.userDeviceSession.findFirst({
    where: { userId, deviceId },
  });

  const sessionData &#x3D; {
    userAgent,
    ipAddress,
    referrer,
    lastLoginAt: new Date(),
    isActive: true,
    deviceType: deviceinfo.deviceType,
    deviceBrand: deviceinfo.deviceBrand,
    deviceModel: deviceinfo.deviceModel,
    osName: deviceinfo.osName,
    osVersion: deviceinfo.osVersion,
    clientName: deviceinfo.clientName,
    clientVersion: deviceinfo.clientVersion,
    clientType: deviceinfo.clientType,
    geoLocation,
  };

  if (deviceSession) {
    deviceSession &#x3D; await prisma.userDeviceSession.update({
      where: { id: deviceSession.id },
      data: sessionData,
    });
  } else {
    deviceSession &#x3D; await prisma.userDeviceSession.create({
      data: {
        userId,
        deviceId,
        ...sessionData,
      },
    });
  }

  return deviceSession;
};

/**
 * Проверка наличия deviceId в заголовках запроса
 * @param {Object} req - Express request объект
 * @returns {string|null} deviceId или null если не найден
 * @example
 * const deviceId &#x3D; getDeviceId(req);
 * if (!deviceId) {
 *   return res.status(401).json({ error: &#x27;Устройство не найдено&#x27; });
 * }
 */
export const getDeviceId &#x3D; (req) &#x3D;&gt; {
  const header &#x3D; req.headers[&#x27;x-device-id&#x27;];
  if (Array.isArray(header)) {
    return header[0] || null;
  }
  return header || null;
};

/**
 * Валидация deviceId
 * @param {Object} req - Express request объект
 * @param {Object} res - Express response объект
 * @returns {string|null} deviceId или null если валидация не прошла
 * @example
 * const deviceId &#x3D; validateDeviceId(req, res);
 * if (!deviceId) return; // res уже отправлен
 */
export const validateDeviceId &#x3D; (req, res) &#x3D;&gt; {
  const deviceId &#x3D; getDeviceId(req);
  
  if (!deviceId) {
    res.status(401).json({ error: &#x27;Устройство не найдено&#x27; });
    return null;
  }
  
  return deviceId;
}; </code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
  <footer id="jsdoc-footer" class="jsdoc-footer">
    <div id="jsdoc-footer-container">
      <p>
        Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> 3.6.11 on July 14, 2025.
      </p>
    </div>
  </footer>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/tree.jquery.js"></script>
  <script src="scripts/prettify.js"></script>
  <script src="scripts/jsdoc-toc.js"></script>
  <script src="scripts/linenumber.js"></script>
  <script src="scripts/scrollanchor.js"></script>
</body>

</html>